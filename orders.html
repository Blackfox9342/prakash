<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>PRAKASH FOOD DELIVIERY SHOP — Orders</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    body{ font-family:Poppins,system-ui,Segoe UI,Roboto,Arial; margin:0; background:#f5f7fb; color:#111827 }
    .wrap{ max-width:900px; margin:28px auto; padding:12px }
    .header{ display:flex; justify-content:space-between; align-items:center; gap:12px }
    h1{ margin:0; font-size:20px }
    .btn{ background:#6c2bd9;color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer }
    .list{ margin-top:18px }
    .card{ background:#fff;border:1px solid #e5e7eb;padding:12px;border-radius:10px;margin-bottom:10px; box-shadow:0 6px 18px rgba(17,24,39,.04); transform-origin:center; transition:transform .18s ease, box-shadow .18s ease }
    .card:hover{ transform:translateY(-6px); box-shadow:0 18px 36px rgba(17,24,39,.08) }
    .muted{ color:#6b7280 }
    table{ width:100%; border-collapse:collapse }
    td,th{ padding:8px; border-bottom:1px solid #eee; text-align:left }
    /* subtle enter animation */
    @keyframes slideFade {
      from { opacity:0; transform:translateY(8px) }
      to { opacity:1; transform:translateY(0) }
    }
    .card{ animation: slideFade .36s ease both }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
  <h1>PRAKASH FOOD DELIVIERY SHOP — Placed Orders</h1>
  <div class="muted">Created by Prakash</div>
      </div>
      <div>
        <button class="btn" id="back">Back to App</button>
      </div>
    </div>

    <div class="list" id="ordersList">Loading orders…</div>
  </div>

  <script>
    document.getElementById('back').addEventListener('click', ()=>{ window.location.href = '/'; });

    async function loadOrders(){
      try{
        // If admin token present, fetch admin orders; otherwise, fetch only orders for the logged-in public user
        const adminToken = localStorage.getItem('p_admin_token');
        if(adminToken){
          const res = await fetch('/api/admin/orders', { headers: { 'x-admin-token': adminToken } });
          if(!res.ok) throw new Error('Failed to fetch admin orders');
          const orders = await res.json();
          render(orders);
          return;
        }

        const puser = JSON.parse(localStorage.getItem('puser') || 'null');
        if(!puser || !puser.phone){
          document.getElementById('ordersList').innerHTML = '<div class="card">Please <a href="/login.html">login</a> to view your orders.</div>';
          return;
        }
        const res = await fetch('/api/orders?phone=' + encodeURIComponent(puser.phone));
        if(!res.ok) throw new Error('Failed to fetch orders');
        const orders = await res.json();
        render(orders);
      }catch(err){
        document.getElementById('ordersList').textContent = 'Unable to load orders.\n' + err;
      }
    }

    function render(orders){
      const wrap = document.getElementById('ordersList');
      if(!orders || orders.length===0){ wrap.innerHTML = '<div class="card">No orders yet.</div>'; return; }
      wrap.innerHTML = '';
      orders.slice().reverse().forEach(o=>{
        const card = document.createElement('div'); card.className='card';
        const h = document.createElement('div'); h.innerHTML = `<strong>Order ID:</strong> ${o.id} <span class="muted" style="margin-left:12px">${o.receivedAt||o.ts||''}</span>`;
        card.appendChild(h);
        const t = document.createElement('table');
        const tbody = document.createElement('tbody');
        o.items.forEach(it=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${it.name}</td><td style="width:90px">Qty: ${it.qty}</td><td style="width:110px">₹${it.price}</td>`;
          tbody.appendChild(tr);
        });
        t.appendChild(tbody);
        card.appendChild(t);
        const foot = document.createElement('div'); foot.style.marginTop='8px'; foot.innerHTML = `<strong>Subtotal:</strong> ₹${o.subtotal} &nbsp;&nbsp; <strong>Delivery:</strong> ₹${o.delivery} &nbsp;&nbsp; <strong>Total:</strong> ₹${o.total}`;
        card.appendChild(foot);
        wrap.appendChild(card);
      });
    }

    loadOrders();
  </script>
</body>
</html>
